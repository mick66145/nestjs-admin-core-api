# 驗證碼功能系統分析文件

> **版本：** v1.0
> **更新日期：** 2025-11-17
> **文件類型：** 系統分析與流程設計文件

---

## 📋 目錄

- [1. 概述](#1-概述)
- [2. 功能概述](#2-功能概述)
- [3. 使用情境範例](#3-使用情境範例)
- [4. 系統流程圖](#4-系統流程圖)
- [5. 時序圖](#5-時序圖)
- [6. 事件流程說明](#6-事件流程說明)
- [7. 業務規則與限制](#7-業務規則與限制)
- [8. 資料流向](#8-資料流向)
- [9. 非功能性需求](#9-非功能性需求)
- [版本歷史](#版本歷史)

---

## 1. 概述

驗證碼（Verification）系統是使用者身份驗證和安全操作的核心機制，用於確保使用者操作的真實性和安全性。系統提供驗證碼的產生、發送和驗證功能，支援多種驗證碼類型，並與使用者帳號系統緊密整合。

### 1.1 系統定位

- **資料類型**：安全驗證資料
- **業務角色**：身份驗證、操作確認
- **關聯模組**：UserAccount（使用者帳號）、Email/SMS 服務
- **使用者群組**：所有系統使用者

### 1.2 核心價值

- ✅ **帳號安全驗證**：提供 Email/手機驗證碼，確保帳號註冊和登入的安全性
- ✅ **密碼重設保護**：透過驗證碼驗證使用者身份，安全地重設密碼
- ✅ **重要操作確認**：針對敏感操作（如變更 Email、刪除帳號）提供二次驗證
- ✅ **防暴力破解**：透過過期機制和一次性使用設計，防止驗證碼被破解
- ✅ **使用者體驗**：快速產生和驗證，提供流暢的驗證流程

### 1.3 驗證碼與認證流程的關係

```
使用者註冊/登入流程
  │
  ├─> 提供 Email/手機號碼
  │
  ├─> 系統產生驗證碼
  │   ├─> 儲存到資料庫
  │   └─> 透過 Email/SMS 發送
  │
  ├─> 使用者接收驗證碼
  │
  ├─> 輸入驗證碼進行驗證
  │   ├─> 驗證成功：繼續流程
  │   └─> 驗證失敗：顯示錯誤
  │
  └─> 完成註冊/登入/操作
```

---

## 2. 功能概述

### 2.1 主要功能

本系統提供驗證碼的完整生命週期管理，包含以下核心功能：

| 功能編號 | 功能名稱       | 功能說明                                 |
| -------- | -------------- | ---------------------------------------- |
| F01      | 產生驗證碼     | 根據使用者需求產生指定類型和長度的驗證碼 |
| F02      | 驗證驗證碼     | 驗證使用者輸入的驗證碼是否正確且有效     |
| F03      | 自動失效機制   | 新驗證碼產生時，自動使舊驗證碼失效       |
| F04      | 過期檢查       | 驗證時檢查驗證碼是否已過期               |
| F05      | 一次性使用     | 驗證成功後標記為已使用，無法重複使用     |

### 2.2 驗證碼類型

系統支援以下三種驗證碼類型：

| 類型           | 說明                         | 字元範圍                 | 使用場景               |
| -------------- | ---------------------------- | ------------------------ | ---------------------- |
| `all`          | 所有字元（數字+大小寫字母）  | 0-9, A-Z, a-z            | 高安全性要求的操作     |
| `number`       | 純數字                       | 0-9                      | 簡訊驗證碼（易輸入）   |
| `alphanumeric` | 數字+字母                    | 0-9, A-Z, a-z            | Email 驗證碼           |

### 2.3 預設配置

| 配置項目     | 預設值        | 說明                       |
| ------------ | ------------- | -------------------------- |
| 驗證碼長度   | 6             | 6 位數字/字元              |
| 驗證碼類型   | `number`      | 預設使用純數字             |
| 過期時間     | 10 分鐘       | 驗證碼有效期限             |

---

## 3. 使用情境範例

### 3.1 情境一：註冊時產生 Email 驗證碼

**流程說明：** 使用者註冊帳號時，系統產生 Email 驗證碼並發送至使用者信箱，確認 Email 擁有權。

**前置條件：**
- 使用者已提供有效的 Email 地址
- 使用者帳號已建立但尚未驗證

**事件流程：**

```
使用者註冊帳號
  │
  ├─> POST /api/user-accounts（建立帳號）
  │   {
  │     email: "user@example.com",
  │     password: "..."
  │   }
  │   └─> 返回 userAccountId
  │
  ├─> POST /api/verification（產生驗證碼）
  │   {
  │     userAccountId: 123,
  │     length: 6,
  │     codeType: "number",
  │     expireMinutes: 10
  │   }
  │
  ├─> [Server] 驗證碼產生處理
  │   ├─> 檢查使用者帳號存在
  │   ├─> 使舊驗證碼失效（如有）
  │   ├─> 產生 6 位數驗證碼（例：123456）
  │   ├─> 計算過期時間（當前時間 + 10 分鐘）
  │   ├─> 儲存驗證碼到資料庫
  │   └─> 返回驗證碼資訊
  │
  ├─> 成功情況：
  │   └─> 返回 200 OK
  │       {
  │         id: 1,
  │         code: "123456",
  │         userAccountId: 123,
  │         isValid: true,
  │         expireAt: "2025-11-17T10:10:00.000Z",
  │         createdAt: "2025-11-17T10:00:00.000Z"
  │       }
  │
  ├─> [後續處理] 發送驗證碼
  │   └─> 呼叫 Email 服務
  │       ├─> 收件人: user@example.com
  │       ├─> 主旨: "驗證您的帳號"
  │       └─> 內容: "您的驗證碼是：123456，有效期限 10 分鐘"
  │
  └─> 失敗情況：
      └─> 使用者帳號不存在 (404 Not Found)
```

**使用場景：**

1. **新使用者註冊**：註冊時驗證 Email 擁有權
2. **Email 變更**：變更 Email 時驗證新 Email
3. **帳號啟用**：管理員建立帳號後，使用者首次啟用
4. **重新發送驗證碼**：使用者未收到驗證碼時重新產生

**實作重點：**

- 產生新驗證碼時，自動使該使用者所有未使用且未過期的驗證碼失效
- 驗證碼應使用隨機產生，確保不可預測性
- Email 發送應為非同步處理，避免阻塞 API 回應
- 驗證碼僅在產生時顯示一次，後續無法查詢

---

### 3.2 情境二：忘記密碼時產生驗證碼

**流程說明：** 使用者忘記密碼時，透過 Email 或手機號碼接收驗證碼，驗證身份後重設密碼。

**事件流程：**

```
使用者忘記密碼
  │
  ├─> POST /api/auth/forgot-password
  │   {
  │     email: "user@example.com"
  │   }
  │
  ├─> [Server] 查詢使用者帳號
  │   ├─> 根據 Email 查詢 UserAccount
  │   ├─> 找到使用者：繼續流程
  │   └─> 未找到：返回成功（安全考量，不透露帳號是否存在）
  │
  ├─> POST /api/verification（產生驗證碼）
  │   {
  │     userAccountId: 123,
  │     length: 6,
  │     codeType: "number",
  │     expireMinutes: 10
  │   }
  │
  ├─> [Server] 驗證碼產生
  │   ├─> 使舊驗證碼失效
  │   ├─> 產生新驗證碼（例：987654）
  │   ├─> 儲存到資料庫
  │   └─> 發送到使用者 Email
  │
  └─> 返回成功訊息
      "如果該帳號存在，驗證碼已發送至您的 Email"
```

**使用場景：**

1. **密碼重設**：忘記密碼時驗證身份
2. **帳號解鎖**：帳號被鎖定時驗證身份
3. **安全性變更**：變更重要設定前的二次驗證

**實作重點：**

- 基於安全考量，無論帳號是否存在，都返回相同的成功訊息
- 限制同一帳號的驗證碼產生頻率（例：1 分鐘內只能產生 1 次）
- 記錄產生驗證碼的 IP 和時間，偵測異常行為
- 驗證碼應有較短的有效期限（建議 10-15 分鐘）

---

### 3.3 情境三：驗證 Email 驗證碼

**流程說明：** 使用者收到驗證碼後，輸入驗證碼進行驗證，系統檢查驗證碼的有效性。

**事件流程：**

```
使用者輸入驗證碼
  │
  ├─> POST /api/verification/verify
  │   {
  │     userAccountId: 123,
  │     code: "123456"
  │   }
  │
  ├─> [Server] 驗證處理
  │   ├─> 查詢驗證碼
  │   │   WHERE userAccountId = 123
  │   │     AND code = "123456"
  │   │     AND isValid = true
  │   │     AND usedAt IS NULL
  │   │
  │   ├─> 檢查驗證碼存在
  │   │   ├─> 不存在：拋出錯誤
  │   │   └─> 存在：繼續檢查
  │   │
  │   ├─> 檢查是否過期
  │   │   ├─> expireAt < NOW()：拋出錯誤
  │   │   └─> 未過期：繼續處理
  │   │
  │   ├─> 標記為已使用
  │   │   UPDATE verification
  │   │   SET usedAt = NOW()
  │   │   WHERE id = ?
  │   │
  │   └─> 返回成功
  │
  ├─> 成功情況：
  │   └─> 返回 204 No Content
  │
  └─> 失敗情況：
      ├─> 驗證碼不存在/錯誤 (400 Bad Request)
      │   "此驗證碼已過期或無效"
      ├─> 驗證碼已過期 (400 Bad Request)
      │   "此驗證碼已過期或無效"
      └─> 驗證碼已使用 (400 Bad Request)
          "此驗證碼已過期或無效"
```

**使用場景：**

1. **完成註冊**：驗證 Email 後啟用帳號
2. **重設密碼**：驗證身份後允許設定新密碼
3. **變更設定**：確認使用者身份後執行敏感操作
4. **交易確認**：重要交易的二次驗證

**實作重點：**

- 驗證成功後立即標記為已使用（usedAt），防止重複使用
- 所有驗證失敗都返回相同的錯誤訊息，避免洩漏資訊
- 限制驗證次數（例：同一驗證碼只能嘗試 5 次）
- 驗證失敗時記錄日誌，偵測可能的攻擊行為

---

### 3.4 情境四：驗證碼過期處理

**流程說明：** 使用者在驗證碼過期後嘗試驗證，系統拒絕驗證並提示重新產生。

**事件流程：**

```
使用者輸入驗證碼（已過期）
  │
  ├─> POST /api/verification/verify
  │   {
  │     userAccountId: 123,
  │     code: "123456"
  │   }
  │
  ├─> [Server] 驗證處理
  │   ├─> 查詢驗證碼
  │   │   找到驗證碼：
  │   │   {
  │   │     code: "123456",
  │   │     isValid: true,
  │   │     usedAt: null,
  │   │     expireAt: "2025-11-17T10:10:00.000Z"
  │   │   }
  │   │
  │   ├─> 檢查過期狀態
  │   │   expireAt (10:10) < NOW() (10:15)
  │   │   └─> 已過期
  │   │
  │   └─> 拋出錯誤
  │       "此驗證碼已過期或無效"
  │
  └─> 失敗回應：
      └─> 400 Bad Request
          {
            statusCode: 400,
            message: "此驗證碼已過期或無效"
          }
```

**使用場景：**

1. **驗證碼超時**：使用者在 10 分鐘後才輸入驗證碼
2. **網路延遲**：使用者收到驗證碼的時間較晚
3. **使用者猶豫**：使用者思考是否繼續操作

**實作重點：**

- 前端應顯示驗證碼的剩餘有效時間
- 提供「重新發送驗證碼」功能
- 過期的驗證碼仍保留在資料庫中（供審計使用）
- 定期清理過期且已使用的驗證碼（資料庫維護）

---

### 3.5 情境五：驗證碼已使用處理

**流程說明：** 使用者嘗試重複使用已驗證過的驗證碼，系統拒絕驗證。

**事件流程：**

```
使用者嘗試重複使用驗證碼
  │
  ├─> POST /api/verification/verify
  │   {
  │     userAccountId: 123,
  │     code: "123456"
  │   }
  │
  ├─> [Server] 驗證處理
  │   ├─> 查詢驗證碼
  │   │   WHERE userAccountId = 123
  │   │     AND code = "123456"
  │   │     AND isValid = true
  │   │     AND usedAt IS NULL
  │   │
  │   ├─> 查詢結果：無符合的記錄
  │   │   （因為 usedAt 不為 NULL）
  │   │
  │   └─> 拋出錯誤
  │       "此驗證碼已過期或無效"
  │
  └─> 失敗回應：
      └─> 400 Bad Request
```

**使用場景：**

1. **重複驗證**：使用者誤以為驗證失敗而重複提交
2. **攻擊行為**：惡意使用者嘗試重複使用截獲的驗證碼
3. **程式錯誤**：前端程式重複發送驗證請求

**實作重點：**

- 驗證成功後立即更新 usedAt，確保無法重複使用
- 一次性使用機制是驗證碼安全性的核心
- 所有失敗情況返回相同錯誤訊息，避免洩漏資訊
- 記錄重複驗證的嘗試，偵測異常行為

---

### 3.6 情境六：產生手機簡訊驗證碼

**流程說明：** 系統產生純數字驗證碼並透過 SMS 服務發送至使用者手機。

**事件流程：**

```
產生手機簡訊驗證碼
  │
  ├─> POST /api/verification
  │   {
  │     userAccountId: 123,
  │     length: 6,
  │     codeType: "number",
  │     expireMinutes: 5
  │   }
  │
  ├─> [Server] 驗證碼產生
  │   ├─> 產生 6 位純數字（例：456789）
  │   ├─> 較短的有效期限（5 分鐘）
  │   ├─> 儲存到資料庫
  │   └─> 返回驗證碼資訊
  │
  ├─> [後續處理] 發送 SMS
  │   └─> 呼叫 SMS 服務
  │       ├─> 手機號碼: +886912345678
  │       └─> 內容: "您的驗證碼是 456789，5分鐘內有效"
  │
  └─> 成功返回
      {
        id: 2,
        code: "456789",
        userAccountId: 123,
        isValid: true,
        expireAt: "2025-11-17T10:05:00.000Z",
        createdAt: "2025-11-17T10:00:00.000Z"
      }
```

**使用場景：**

1. **手機號碼驗證**：註冊或變更手機號碼
2. **快速驗證**：需要快速驗證的場景
3. **雙因素認證**：登入時的第二層驗證
4. **交易確認**：金融交易的 OTP 驗證

**實作重點：**

- 簡訊驗證碼建議使用純數字（易於輸入）
- 有效期限建議較短（5-10 分鐘）
- 限制發送頻率，避免 SMS 服務濫用
- 記錄 SMS 發送日誌，追蹤發送狀態和成本

---

## 4. 系統流程圖

### 4.1 產生驗證碼流程

```
產生驗證碼請求
  │
  ├─> POST /api/verification
  │   {
  │     userAccountId: 123,
  │     length: 6,
  │     codeType: "number",
  │     expireMinutes: 10
  │   }
  │
  ├─> [Controller] 接收請求
  │   ├─> 參數驗證 (CreateVerificationDto)
  │   │   ├─> @IsInt() userAccountId
  │   │   ├─> @IsPositive() length
  │   │   ├─> @IsEnum(CodeType) codeType
  │   │   └─> @IsPositive() expireMinutes
  │   │
  │   └─> 呼叫 Service.create(dto)
  │
  ├─> [Service] 業務邏輯處理
  │   ├─> 驗證使用者帳號存在
  │   │   ├─> 查詢 User (userAccountId)
  │   │   ├─> 找到：繼續處理
  │   │   └─> 未找到：拋出 404 錯誤
  │   │
  │   ├─> 產生驗證碼
  │   │   ├─> 根據 codeType 選擇字元集
  │   │   │   ├─> number: 0-9
  │   │   │   ├─> alphanumeric: 0-9, A-Z, a-z
  │   │   │   └─> all: 0-9, A-Z, a-z
  │   │   ├─> 使用隨機函數產生指定長度的驗證碼
  │   │   └─> 例：generateRandomString(6, ['NUMBER'])
  │   │
  │   ├─> 計算過期時間
  │   │   └─> expireAt = NOW() + expireMinutes
  │   │
  │   ├─> 使用事務處理
  │   │   ├─> 使舊驗證碼失效
  │   │   │   UPDATE verification
  │   │   │   SET isValid = false
  │   │   │   WHERE userAccountId = ?
  │   │   │     AND isValid = true
  │   │   │     AND usedAt IS NULL
  │   │   │     AND expireAt > NOW()
  │   │   │
  │   │   ├─> 建立新驗證碼
  │   │   │   INSERT INTO verification
  │   │   │   (userAccountId, code, expireAt)
  │   │   │   VALUES (?, ?, ?)
  │   │   │
  │   │   └─> 提交事務
  │   │
  │   └─> plainToInstance(VerificationEntity, orm)
  │
  └─> [Controller] 返回回應
      └─> 200 OK + VerificationEntity
```

### 4.2 驗證驗證碼流程

```
驗證驗證碼請求
  │
  ├─> POST /api/verification/verify
  │   {
  │     userAccountId: 123,
  │     code: "123456"
  │   }
  │
  ├─> [Controller] 接收請求
  │   ├─> 參數驗證 (VerifyCodeDto)
  │   │   ├─> @IsInt() userAccountId
  │   │   └─> @IsNotEmpty() code
  │   │
  │   └─> 呼叫 Service.verify(dto)
  │
  ├─> [Service] 驗證邏輯處理
  │   ├─> 查詢驗證碼
  │   │   SELECT * FROM verification
  │   │   WHERE userAccountId = ?
  │   │     AND code = ?
  │   │     AND isValid = true
  │   │     AND usedAt IS NULL
  │   │
  │   ├─> 檢查驗證碼存在
  │   │   ├─> 不存在：拋出 400 錯誤
  │   │   └─> 存在：繼續驗證
  │   │
  │   ├─> 檢查是否過期
  │   │   ├─> expireAt < NOW()：拋出 400 錯誤
  │   │   │   "此驗證碼已過期或無效"
  │   │   └─> 未過期：繼續處理
  │   │
  │   ├─> 標記為已使用
  │   │   UPDATE verification
  │   │   SET usedAt = NOW()
  │   │   WHERE id = ?
  │   │
  │   └─> 返回成功
  │
  └─> [Controller] 返回回應
      └─> 204 No Content
```

### 4.3 自動失效舊驗證碼流程

```
產生新驗證碼
  │
  ├─> 使用資料庫事務
  │
  ├─> [步驟 1] 使舊驗證碼失效
  │   │
  │   ├─> 查詢條件：
  │   │   ├─> userAccountId = 當前使用者
  │   │   ├─> isValid = true（仍然有效）
  │   │   ├─> usedAt IS NULL（未使用）
  │   │   └─> expireAt > NOW()（未過期）
  │   │
  │   ├─> 更新操作：
  │   │   UPDATE verification
  │   │   SET isValid = false
  │   │   WHERE [查詢條件]
  │   │
  │   └─> 結果：所有符合條件的舊驗證碼被標記為無效
  │
  ├─> [步驟 2] 建立新驗證碼
  │   │
  │   ├─> INSERT INTO verification
  │   │   (userAccountId, code, expireAt, isValid)
  │   │   VALUES (?, ?, ?, true)
  │   │
  │   └─> 結果：新驗證碼已建立
  │
  └─> 提交事務
      ├─> 成功：兩步驟都完成
      └─> 失敗：全部回滾
```

---

## 5. 時序圖

### 5.1 產生驗證碼時序圖

```
[客戶端]    [Controller]   [Service]      [Prisma]       [資料庫]     [Email/SMS]
   │              │             │              │              │              │
   ├─ POST ──────>│             │              │              │              │
   │  /verification│             │              │              │              │
   │              │ (參數驗證)   │              │              │              │
   │              ├─ create(dto)>│              │              │              │
   │              │             ├─ findFirst ─>│              │              │
   │              │             │ (檢查帳號)    ├─ SELECT ───>│              │
   │              │             │              │<─ User ──────┤              │
   │              │             │<─ User ──────┤              │              │
   │              │             │              │              │              │
   │              │             │ (產生驗證碼)  │              │              │
   │              │             │ (計算過期時間)│              │              │
   │              │             │              │              │              │
   │              │             ├─ $transaction>│              │              │
   │              │             │              ├─ UPDATE ────>│              │
   │              │             │              │ (使舊碼失效)  │              │
   │              │             │              ├─ INSERT ────>│              │
   │              │             │              │ (新驗證碼)    │              │
   │              │             │              │<─ 新記錄 ────┤              │
   │              │             │<─ ORM ───────┤              │              │
   │              │             │ (轉換 Entity) │              │              │
   │              │<─ Entity ───┤              │              │              │
   │<─ 200 OK ────┤              │              │              │              │
   │   + Entity   │              │              │              │              │
   │              │              │              │              │              │
   │              │ [非同步處理] │              │              │              │
   │              ├──────────────────────────────────────────────> 發送 ────>│
   │              │              │              │              │   驗證碼     │
   │              │              │              │              │              │
```

### 5.2 驗證驗證碼時序圖

```
[客戶端]    [Controller]   [Service]      [Prisma]       [資料庫]
   │              │             │              │              │
   ├─ POST ──────>│             │              │              │
   │  /verify     │             │              │              │
   │  {code:...}  │ (參數驗證)   │              │              │
   │              ├─ verify(dto)>│              │              │
   │              │             ├─ findFirst ─>│              │
   │              │             │ WHERE code=? ├─ SELECT ───>│
   │              │             │   AND valid  │ + 多條件查詢 │
   │              │             │              │<─ 驗證碼 ────┤
   │              │             │<─ ORM ───────┤              │
   │              │             │              │              │
   │              │             │ (檢查存在)    │              │
   │              │             │ (檢查過期)    │              │
   │              │             │              │              │
   │              │             │ 驗證通過：    │              │
   │              │             ├─ update ────>│              │
   │              │             │ SET usedAt   ├─ UPDATE ───>│
   │              │             │              │<─ 成功 ──────┤
   │              │             │<─ void ──────┤              │
   │              │<─ void ─────┤              │              │
   │<─ 204 ────────┤             │              │              │
   │   No Content │             │              │              │
   │              │             │              │              │
   │              │             │ 驗證失敗：    │              │
   │              │<─ 400 Error ┤              │              │
   │<─ 400 ────────┤             │              │              │
   │   Bad Request│             │              │              │
   │              │             │              │              │
```

### 5.3 完整註冊流程時序圖（含驗證碼）

```
[使用者]  [前端]     [Auth API]   [Verification API]  [Email Service]
   │         │            │                │                 │
   ├─ 註冊 ─>│            │                │                 │
   │         ├─ POST ────>│                │                 │
   │         │ /register  │                │                 │
   │         │            │ (建立帳號)      │                 │
   │         │<─ 201 ─────┤                │                 │
   │         │   {userId} │                │                 │
   │         │            │                │                 │
   │         ├─ POST ─────────────────────>│                 │
   │         │ /verification              │                 │
   │         │ {userAccountId}            │ (產生驗證碼)     │
   │         │                            │                 │
   │         │<─ 200 ─────────────────────┤                 │
   │         │   {code: "123456"}         │                 │
   │         │                            ├─ 發送 ─────────>│
   │         │                            │   Email         │
   │<─ Email ──────────────────────────────────────────────┤
   │   "驗證碼:123456"                    │                 │
   │         │                            │                 │
   ├─ 輸入碼 >│                            │                 │
   │         ├─ POST ─────────────────────>│                 │
   │         │ /verification/verify       │                 │
   │         │ {code: "123456"}           │ (驗證)          │
   │         │                            │                 │
   │         │<─ 204 ─────────────────────┤                 │
   │         │   驗證成功                  │                 │
   │         │            │                │                 │
   │         ├─ PUT ─────>│                │                 │
   │         │ /user/activate             │                 │
   │         │            │ (啟用帳號)      │                 │
   │         │<─ 200 ─────┤                │                 │
   │<─ 成功 ──┤            │                │                 │
   │         │            │                │                 │
```

---

## 6. 事件流程說明

### 6.1 產生驗證碼事件流程

| 步驟 | 角色       | 動作                           | 說明                               |
| ---- | ---------- | ------------------------------ | ---------------------------------- |
| 1    | 客戶端     | 發送 POST 請求                 | 包含使用者 ID 和驗證碼設定         |
| 2    | Controller | 接收請求並驗證參數             | 使用 class-validator 自動驗證      |
| 3    | Service    | 驗證使用者帳號存在             | 查詢 User 表，確認帳號有效         |
| 4    | Service    | 產生隨機驗證碼                 | 根據 codeType 產生指定長度的驗證碼 |
| 5    | Service    | 計算過期時間                   | expireAt = NOW() + expireMinutes   |
| 6    | Service    | 開啟資料庫事務                 | 確保操作的原子性                   |
| 7    | Service    | 使舊驗證碼失效                 | UPDATE isValid = false             |
| 8    | Service    | 建立新驗證碼記錄               | INSERT INTO verification           |
| 9    | Service    | 提交事務                       | 完成資料庫操作                     |
| 10   | Service    | 轉換為 Entity                  | 使用 plainToInstance              |
| 11   | Controller | 返回 HTTP 200 OK               | 包含驗證碼資訊                     |
| 12   | 非同步     | 發送 Email/SMS                 | 將驗證碼發送給使用者               |

### 6.2 驗證驗證碼事件流程

| 步驟 | 角色       | 動作                           | 說明                               |
| ---- | ---------- | ------------------------------ | ---------------------------------- |
| 1    | 客戶端     | 發送 POST 請求                 | 包含使用者 ID 和驗證碼             |
| 2    | Controller | 接收請求並驗證參數             | 驗證必填欄位                       |
| 3    | Service    | 查詢驗證碼                     | 多條件查詢：ID、code、valid、未使用|
| 4    | Service    | 檢查驗證碼存在                 | 不存在則拋出 400 錯誤              |
| 5    | Service    | 檢查是否過期                   | expireAt < NOW() 則拋出 400 錯誤   |
| 6    | Service    | 標記為已使用                   | UPDATE usedAt = NOW()              |
| 7    | Controller | 返回 HTTP 204 No Content       | 驗證成功，無回應內容               |

### 6.3 自動失效機制事件流程

| 步驟 | 角色       | 動作                           | 說明                               |
| ---- | ---------- | ------------------------------ | ---------------------------------- |
| 1    | Service    | 開啟資料庫事務                 | 確保兩步驟的原子性                 |
| 2    | Service    | 查詢需失效的驗證碼             | 同使用者、有效、未使用、未過期     |
| 3    | Service    | 批量更新為無效                 | UPDATE isValid = false             |
| 4    | Service    | 建立新驗證碼                   | INSERT 新記錄                      |
| 5    | Service    | 提交事務                       | 確保全部成功或全部失敗             |

---

## 7. 業務規則與限制

### 7.1 驗證碼產生規則

| 規則項目         | 規則說明                                   | 實作方式                       |
| ---------------- | ------------------------------------------ | ------------------------------ |
| 長度限制         | 預設 6 位，可自訂（建議 4-8 位）           | DTO 驗證：@IsPositive()        |
| 字元集選擇       | number/alphanumeric/all                    | Enum 驗證：@IsEnum(CodeType)   |
| 隨機性           | 必須使用密碼學安全的隨機函數               | generateRandomString()         |
| 唯一性           | 同一時間每個使用者只有一個有效驗證碼       | 事務處理：先失效舊碼           |
| 過期時間         | 預設 10 分鐘，可自訂（建議 5-30 分鐘）     | DTO 驗證：@IsPositive()        |

### 7.2 驗證規則

| 規則項目         | 規則說明                                   | 錯誤處理                       |
| ---------------- | ------------------------------------------ | ------------------------------ |
| 帳號存在性       | 驗證碼必須關聯到有效的使用者帳號           | 404 Not Found                  |
| 驗證碼正確性     | 輸入的驗證碼必須與資料庫記錄完全一致       | 400 Bad Request                |
| 有效性檢查       | isValid 必須為 true                        | 400 Bad Request                |
| 使用狀態檢查     | usedAt 必須為 NULL（未使用）               | 400 Bad Request                |
| 過期檢查         | expireAt 必須大於當前時間                  | 400 Bad Request                |
| 一次性使用       | 驗證成功後立即標記 usedAt                  | UPDATE 即時執行                |

### 7.3 安全性規則

| 規則項目         | 規則說明                                   | 實作建議                       |
| ---------------- | ------------------------------------------ | ------------------------------ |
| 統一錯誤訊息     | 所有驗證失敗都返回相同訊息                 | "此驗證碼已過期或無效"         |
| 頻率限制         | 同一帳號 1 分鐘內最多產生 3 次驗證碼       | Redis 計數器或資料庫記錄       |
| 嘗試次數限制     | 同一驗證碼最多嘗試 5 次                    | 記錄失敗次數，超過則失效       |
| IP 限制          | 同一 IP 每小時最多產生 10 次驗證碼         | Redis 或速率限制中介層         |
| 驗證碼複雜度     | 避免簡單序列（如 123456、111111）          | 產生時檢查規則（可選）         |

### 7.4 系統限制

| 項目           | 限制                     | 說明                           |
| -------------- | ------------------------ | ------------------------------ |
| 最大長度       | 12 位                    | 避免過長的驗證碼               |
| 最小長度       | 4 位                     | 確保安全性                     |
| 最短有效期     | 1 分鐘                   | 避免過短導致無法驗證           |
| 最長有效期     | 60 分鐘                  | 避免過長導致安全風險           |
| 單使用者上限   | 同時存在 5 個未使用驗證碼 | 防止濫用（建議實作）           |

### 7.5 資料清理規則

| 清理項目         | 清理條件                                   | 執行頻率                       |
| ---------------- | ------------------------------------------ | ------------------------------ |
| 已使用驗證碼     | usedAt 不為 NULL 且超過 30 天              | 每日執行                       |
| 已過期驗證碼     | expireAt < NOW() 且超過 7 天               | 每日執行                       |
| 失效驗證碼       | isValid = false 且超過 7 天                | 每日執行                       |

### 7.6 錯誤處理規則

**統一錯誤訊息原則：**

所有驗證失敗的情況都應返回相同的錯誤訊息，避免洩漏資訊：

```json
{
  "statusCode": 400,
  "message": "此驗證碼已過期或無效"
}
```

**不應該區分的情況：**
- 驗證碼不存在
- 驗證碼錯誤
- 驗證碼已過期
- 驗證碼已使用
- 驗證碼已失效

這樣可以防止攻擊者透過錯誤訊息差異進行資訊收集。

---

## 8. 資料流向

### 8.1 整體資料流向

```
使用者操作
  │
  ↓
前端應用程式
  │
  ├─> [產生驗證碼] POST /api/verification
  │   {
  │     userAccountId: 123,
  │     length: 6,
  │     codeType: "number",
  │     expireMinutes: 10
  │   }
  │
  ↓
NestJS Controller
  │
  ├─> 參數驗證 (class-validator)
  └─> 呼叫 Service
  │
  ↓
Verification Service
  │
  ├─> 驗證使用者存在
  ├─> 產生隨機驗證碼
  ├─> 計算過期時間
  └─> 資料庫事務處理
  │
  ↓
Prisma ORM
  │
  ├─> UPDATE（使舊驗證碼失效）
  └─> INSERT（建立新驗證碼）
  │
  ↓
PostgreSQL 資料庫
  │
  ├─> 儲存驗證碼記錄
  └─> 返回建立結果
  │
  ↓
Service 層
  │
  └─> plainToInstance(VerificationEntity)
  │
  ↓
Controller 層
  │
  ├─> 返回 200 OK + VerificationEntity
  └─> [非同步] 發送 Email/SMS
  │
  ↓
前端應用程式
  │
  └─> 顯示「驗證碼已發送」訊息
  │
  ↓
使用者
  │
  └─> 接收並輸入驗證碼
```

### 8.2 驗證流程資料流向

```
使用者輸入驗證碼
  │
  ↓
前端應用程式
  │
  ├─> [驗證] POST /api/verification/verify
  │   {
  │     userAccountId: 123,
  │     code: "123456"
  │   }
  │
  ↓
Controller → Service
  │
  ├─> 查詢驗證碼（多條件）
  ├─> 檢查存在性
  ├─> 檢查過期狀態
  └─> 標記已使用
  │
  ↓
Prisma ORM
  │
  ├─> SELECT（查詢驗證碼）
  └─> UPDATE（標記 usedAt）
  │
  ↓
PostgreSQL 資料庫
  │
  └─> 返回結果
  │
  ↓
Controller
  │
  └─> 返回 204 No Content
  │
  ↓
前端應用程式
  │
  └─> 執行後續操作（如啟用帳號、重設密碼）
```

### 8.3 Email/SMS 發送流程

```
驗證碼產生成功
  │
  ↓
[非同步處理] 發送服務
  │
  ├─> 取得使用者 Email/手機號碼
  │
  ├─> 建構訊息內容
  │   ├─> 主旨/標題
  │   ├─> 驗證碼內容
  │   └─> 有效期限提示
  │
  ├─> 呼叫 Email/SMS 服務 API
  │   ├─> Email: SendGrid/AWS SES
  │   └─> SMS: Twilio/AWS SNS
  │
  ├─> 記錄發送日誌
  │   ├─> 發送時間
  │   ├─> 發送狀態
  │   └─> 錯誤訊息（如有）
  │
  └─> 結束（不阻塞主流程）
```

---

## 9. 非功能性需求

### 9.1 安全性需求

| 項目               | 需求                           | 實作方式                       |
| ------------------ | ------------------------------ | ------------------------------ |
| 驗證碼隨機性       | 使用密碼學安全的隨機函數       | crypto.randomBytes()           |
| 防暴力破解         | 限制驗證嘗試次數               | 記錄失敗次數，超過則鎖定       |
| 防資訊洩漏         | 統一錯誤訊息                   | 所有失敗都返回相同訊息         |
| 防重複使用         | 一次性使用機制                 | usedAt 標記                    |
| 防中間人攻擊       | 強制 HTTPS 傳輸                | Nginx/Load Balancer 設定       |
| 短效期設計         | 限制驗證碼有效時間             | 預設 10 分鐘                   |
| 頻率限制           | 限制產生和驗證頻率             | Redis 計數器                   |

### 9.2 效能需求

| 項目           | 需求                       | 說明                           |
| -------------- | -------------------------- | ------------------------------ |
| 產生回應時間   | < 300ms                    | 包含資料庫操作                 |
| 驗證回應時間   | < 200ms                    | 單一查詢 + 更新                |
| 並發處理       | 支援 500+ 並發請求         | 使用資料庫連線池               |
| Email/SMS 發送 | 非同步處理，不阻塞回應     | 使用訊息佇列或背景任務         |

### 9.3 可用性需求

| 項目         | 需求                   | 說明                           |
| ------------ | ---------------------- | ------------------------------ |
| 系統可用性   | 99.9%                  | 年停機時間不超過 8.76 小時     |
| 錯誤處理     | 完整的錯誤訊息         | 協助使用者理解問題             |
| 日誌記錄     | 記錄所有驗證操作       | 便於問題追蹤和安全審計         |
| 監控告警     | 異常行為即時告警       | 偵測暴力破解、大量產生等       |

### 9.4 資料保護需求

| 項目           | 需求                       | 說明                           |
| -------------- | -------------------------- | ------------------------------ |
| 驗證碼儲存     | 明文儲存（僅限驗證）       | 不需要加密（短效期、一次性）   |
| 傳輸加密       | HTTPS 強制加密             | 保護驗證碼在傳輸中的安全       |
| 日誌保護       | 不記錄完整驗證碼           | 僅記錄部分字元（如 12****）    |
| 資料保留       | 定期清理過期資料           | 避免資料庫膨脹                 |

### 9.5 可維護性需求

| 項目         | 需求                   | 說明                           |
| ------------ | ---------------------- | ------------------------------ |
| 程式碼規範   | 遵循專案 Code Style    | 保持程式碼一致性               |
| 單元測試     | 測試覆蓋率 > 80%       | 確保功能正確性                 |
| 日誌完整性   | 記錄關鍵操作           | 產生、驗證、失敗原因           |
| 配置化       | 長度、類型、過期時間   | 透過設定檔調整                 |

### 9.6 監控與告警

**需要監控的指標：**

1. **產生驗證碼頻率**
   - 監控每分鐘產生的驗證碼數量
   - 告警閾值：單一使用者 > 5 次/分鐘

2. **驗證失敗率**
   - 監控驗證失敗的比例
   - 告警閾值：失敗率 > 50%

3. **驗證碼過期率**
   - 監控因過期而驗證失敗的比例
   - 用於調整預設過期時間

4. **Email/SMS 發送失敗率**
   - 監控發送服務的成功率
   - 告警閾值：失敗率 > 5%

5. **異常 IP 活動**
   - 監控單一 IP 的請求頻率
   - 告警閾值：> 20 次/分鐘

---

## 版本歷史

| 版本 | 日期       | 說明                                             | 作者  |
| ---- | ---------- | ------------------------------------------------ | ----- |
| v1.0 | 2025-11-17 | 初版發布，基於現有程式碼分析撰寫系統分析文件     | Claude |

---

**© 2025 Sys Public Property API Documentation Team. All rights reserved.**
