# 帳號管理模組 - 系統分析文件（SA）

> **版本：** v1.0
> **更新日期：** 2025-01-17
> **文件類型：** 系統分析與流程設計文件

---

## 📋 目錄

- [1. 概述](#1-概述)
- [2. 功能概述](#2-功能概述)
- [3. 使用情境範例](#3-使用情境範例)
- [4. 系統流程圖](#4-系統流程圖)
- [5. 時序圖](#5-時序圖)
- [6. 事件流程說明](#6-事件流程說明)
- [7. 業務規則與限制](#7-業務規則與限制)
- [8. 資料流向](#8-資料流向)
- [9. 非功能性需求](#9-非功能性需求)
- [10. 版本歷史](#10-版本歷史)

---

## 1. 概述

帳號管理模組（User Account Module）提供公有資產管理系統的基礎認證功能，負責處理使用者帳號的註冊、登入、密碼管理等核心認證需求。本模組支援多種帳號類型（本地帳號、Google、Line、Apple），為系統提供安全可靠的使用者認證機制。

### 1.1 系統定位

- **模組類型**：核心基礎模組
- **業務角色**：使用者認證與帳號管理
- **關聯模組**：User（使用者）、Role（角色）、Verification（驗證）
- **使用者群組**：系統管理員、一般使用者

### 1.2 與 User 模組的關係

本系統採用「帳號」與「使用者」分離的設計：

- **UserAccount（帳號）**：負責認證，一個帳號對應一組登入憑證（帳號+密碼或第三方登入）
- **User（使用者）**：負責個人資料，包含姓名、電話、Email 等個人資訊
- **關聯關係**：一個 UserAccount 可以對應多個 User（不同租戶的使用者資料）

---

## 2. 功能概述

### 2.1 核心功能

本模組提供以下核心功能：

- ✅ **帳號註冊**：建立新的使用者帳號（支援本地帳號與第三方帳號）
- ✅ **帳號登入**：驗證使用者身份並核發存取憑證
- ✅ **密碼管理**：修改密碼、重設密碼功能
- ✅ **帳號查詢**：查詢帳號資訊與登入記錄
- ✅ **帳號刪除**：刪除使用者帳號（軟刪除機制）
- ✅ **多帳號類型支援**：支援 Local、Google、Line、Apple 等帳號類型

### 2.2 業務價值

- **安全性保障**：透過密碼加密、驗證機制確保帳號安全
- **多元登入方式**：支援第三方登入，提升使用者體驗
- **密碼安全管理**：提供完整的密碼修改與重設流程
- **帳號生命週期管理**：完整的帳號建立、使用、刪除管理
- **最後登入追蹤**：記錄使用者最後登入時間，便於監控帳號活躍度

### 2.3 支援的帳號類型

```typescript
enum AccountType {
  Local = 'Local',      // 本地帳號（帳號+密碼）
  Google = 'Google',    // Google 帳號
  Line = 'Line',        // Line 帳號
  Apple = 'Apple',      // Apple 帳號
}
```

---

## 3. 使用情境範例

### 3.1 情境一：註冊新帳號

**流程說明：** 使用者透過系統註冊功能建立新的本地帳號。

**前置條件：**
- 系統開放註冊功能
- 帳號名稱尚未被使用

**事件流程：**

```
使用者填寫註冊資料
  │
  ├─> POST /api/user-account/register
  │   {
  │     account: "user001",
  │     password: "securePass123"
  │   }
  │
  ├─> [Server] 驗證與處理
  │   ├─> 驗證帳號格式與密碼長度（5-20位）
  │   ├─> 檢查帳號是否已存在
  │   ├─> 加密密碼（使用 bcrypt）
  │   ├─> 建立 UserAccount 記錄（type: "Local"）
  │   └─> 記錄建立時間
  │
  ├─> 成功回應：
  │   └─> 返回 200 OK
  │       {
  │         id: 1,
  │         type: "Local",
  │         account: "user001",
  │         createdAt: "2025-01-17T10:00:00.000Z"
  │       }
  │
  └─> 失敗回應：
      ├─> 400 Bad Request（參數驗證錯誤）
      └─> 409 Conflict（帳號已存在，如有實作）
```

**使用場景：**

1. 新使用者首次使用系統，建立帳號
2. 管理員為員工批次建立系統帳號
3. 系統整合測試時建立測試帳號

**實作重點：**

- 密碼必須經過 bcrypt 加密後才能儲存
- 密碼長度限制為 5-20 個字元
- 帳號類型預設為 "Local"
- 建立時不設定 lastLoginAt，待首次登入後更新

---

### 3.2 情境二：帳號登入

**流程說明：** 使用者使用帳號密碼進行登入驗證，系統驗證成功後核發 JWT Token。

**前置條件：**
- 帳號已註冊
- 密碼正確

**事件流程：**

```
使用者輸入登入資訊
  │
  ├─> POST /api/user-account/login
  │   {
  │     account: "user001",
  │     password: "securePass123"
  │   }
  │
  ├─> [Server] 驗證流程
  │   ├─> 依據 account 查詢帳號資料
  │   ├─> 檢查帳號是否存在
  │   ├─> 使用 bcrypt 比對密碼
  │   ├─> 驗證成功後更新 lastLoginAt
  │   └─> 核發 JWT Token（透過其他模組）
  │
  ├─> 成功回應：
  │   └─> 返回 200 OK
  │       {
  │         id: 1,
  │         type: "Local",
  │         account: "user001",
  │         createdAt: "2025-01-17T10:00:00.000Z",
  │         lastLoginAt: "2025-01-17T14:30:00.000Z"
  │       }
  │       + JWT Token (在 Cookie 或 Header 中)
  │
  └─> 失敗回應：
      ├─> 400 Bad Request（參數格式錯誤）
      ├─> 401 Unauthorized（帳號不存在或密碼錯誤）
      └─> 403 Forbidden（帳號已被停用，如有實作）
```

**時序圖：**

```
[客戶端]          [UserAccountController]    [UserAccountService]    [資料庫]
   │                      │                          │                  │
   ├─ 登入請求 ──────────>│                          │                  │
   │                      ├─ login() ───────────────>│                  │
   │                      │                          ├─ 查詢帳號 ──────>│
   │                      │                          │<─ 帳號資料 ──────┤
   │                      │                          │ (驗證密碼)        │
   │                      │                          ├─ 更新登入時間 ──>│
   │                      │                          │<─ 更新成功 ──────┤
   │                      │<─ 帳號資料 ──────────────┤                  │
   │<─ 登入成功 ──────────┤                          │                  │
   │                      │                          │                  │
```

**使用場景：**

1. 使用者每日登入系統進行工作
2. 使用者登入後台管理介面
3. API 整合時使用服務帳號登入

**實作重點：**

- 登入成功後必須更新 lastLoginAt 欄位
- 密碼比對使用 bcrypt.compare()
- 登入失敗不應明確指出是帳號或密碼錯誤（安全考量）
- 可考慮實作登入失敗次數限制（防暴力破解）

---

### 3.3 情境三：修改密碼

**流程說明：** 已登入使用者修改自己的密碼，需要提供舊密碼進行驗證。

**前置條件：**
- 使用者已登入
- 知道目前密碼

**事件流程：**

```
使用者修改密碼
  │
  ├─> PATCH /api/user-account/:id/password
  │   {
  │     oldPassword: "securePass123",
  │     newPassword: "newSecurePass456"
  │   }
  │
  ├─> [Server] 驗證與處理
  │   ├─> 驗證使用者權限（只能修改自己的密碼）
  │   ├─> 查詢帳號資料
  │   ├─> 使用 bcrypt 驗證舊密碼
  │   ├─> 檢查新密碼格式（5-20位）
  │   ├─> 檢查新舊密碼不可相同
  │   ├─> 加密新密碼
  │   └─> 更新密碼欄位
  │
  ├─> 成功回應：
  │   └─> 返回 200 OK
  │       {
  │         id: 1,
  │         type: "Local",
  │         account: "user001",
  │         createdAt: "2025-01-17T10:00:00.000Z",
  │         lastLoginAt: "2025-01-17T14:30:00.000Z"
  │       }
  │
  └─> 失敗回應：
      ├─> 400 Bad Request（參數驗證錯誤、新舊密碼相同）
      ├─> 401 Unauthorized（舊密碼錯誤）
      └─> 403 Forbidden（無權限修改此帳號）
```

**使用場景：**

1. 使用者定期更換密碼以提升安全性
2. 懷疑密碼外洩時主動修改密碼
3. 系統強制要求定期修改密碼

**實作重點：**

- 必須驗證舊密碼正確才能修改
- 新密碼不可與舊密碼相同
- 新密碼必須符合長度規範（5-20位）
- 使用者只能修改自己的密碼（權限檢查）

---

### 3.4 情境四：重設密碼

**流程說明：** 管理員或透過驗證流程為帳號重設密碼（無需提供舊密碼）。

**前置條件：**
- 擁有重設密碼權限（管理員）或已完成身份驗證（如 Email/SMS 驗證碼）

**事件流程：**

```
管理員重設使用者密碼
  │
  ├─> PUT /api/user-account/:id/password
  │   {
  │     newPassword: "resetPass789"
  │   }
  │
  ├─> [Server] 驗證與處理
  │   ├─> 驗證管理員權限或驗證碼有效性
  │   ├─> 查詢帳號資料
  │   ├─> 檢查新密碼格式（5-20位）
  │   ├─> 加密新密碼
  │   └─> 更新密碼欄位
  │
  ├─> 成功回應：
  │   └─> 返回 200 OK
  │       {
  │         id: 1,
  │         type: "Local",
  │         account: "user001",
  │         createdAt: "2025-01-17T10:00:00.000Z",
  │         lastLoginAt: "2025-01-17T14:30:00.000Z"
  │       }
  │
  └─> 失敗回應：
      ├─> 400 Bad Request（參數驗證錯誤）
      ├─> 403 Forbidden（無重設權限）
      └─> 404 Not Found（帳號不存在）
```

**使用場景：**

1. 使用者忘記密碼，透過 Email/SMS 驗證碼重設
2. 管理員為員工重設忘記的密碼
3. 帳號疑似被盜，緊急重設密碼

**實作重點：**

- 重設密碼不需要舊密碼
- 必須有適當的權限驗證（管理員或驗證碼）
- 建議重設後要求使用者再次登入
- 可考慮發送通知信件告知密碼已重設

---

### 3.5 情境五：查詢帳號列表

**流程說明：** 管理員查詢系統中的所有帳號資料，支援分頁與篩選。

**前置條件：**
- 使用者擁有查詢帳號列表的權限

**事件流程：**

```
管理員查詢帳號列表
  │
  ├─> GET /api/user-account?page=1&limit=20&search=user
  │
  ├─> [Server] 查詢處理
  │   ├─> 驗證使用者權限
  │   ├─> 解析查詢參數（分頁、搜尋關鍵字、排序）
  │   ├─> 建構資料庫查詢
  │   ├─> 執行查詢並計算總筆數
  │   └─> 組織回應資料
  │
  └─> 成功回應：
      └─> 返回 200 OK
          {
            data: [
              {
                id: 1,
                type: "Local",
                account: "user001",
                createdAt: "2025-01-17T10:00:00.000Z",
                lastLoginAt: "2025-01-17T14:30:00.000Z"
              },
              ...
            ],
            meta: {
              totalCount: 150,
              page: 1,
              limit: 20
            }
          }
```

**使用場景：**

1. 管理員檢視系統中所有註冊的帳號
2. 搜尋特定帳號資訊
3. 統計分析不同類型的帳號數量
4. 查看最近登入的活躍帳號

---

### 3.6 情境六：查詢單一帳號

**流程說明：** 查詢指定帳號的詳細資訊。

**前置條件：**
- 使用者擁有查詢權限
- 帳號存在

**事件流程：**

```
查詢帳號資訊
  │
  ├─> GET /api/user-account/:id
  │
  ├─> [Server] 查詢處理
  │   ├─> 驗證使用者權限
  │   ├─> 依據 ID 查詢帳號資料
  │   ├─> 檢查帳號是否存在
  │   └─> 返回帳號資訊（不含密碼）
  │
  ├─> 成功回應：
  │   └─> 返回 200 OK
  │       {
  │         id: 1,
  │         type: "Local",
  │         account: "user001",
  │         createdAt: "2025-01-17T10:00:00.000Z",
  │         lastLoginAt: "2025-01-17T14:30:00.000Z"
  │       }
  │
  └─> 失敗回應：
      ├─> 403 Forbidden（無查詢權限）
      └─> 404 Not Found（帳號不存在）
```

**使用場景：**

1. 管理員查看特定帳號的詳細資訊
2. 使用者查看自己的帳號資料
3. 系統審計時檢視帳號登入記錄

---

### 3.7 情境七：刪除帳號

**流程說明：** 管理員刪除不再需要的使用者帳號（軟刪除機制）。

**前置條件：**
- 使用者擁有刪除帳號權限
- 帳號存在且未被刪除

**事件流程：**

```
管理員刪除帳號
  │
  ├─> DELETE /api/user-account/:id
  │
  ├─> [Server] 刪除處理
  │   ├─> 驗證使用者權限
  │   ├─> 查詢帳號是否存在
  │   ├─> 檢查帳號關聯資料（User、Role 等）
  │   ├─> 執行軟刪除（標記 deletedAt）
  │   └─> 相關聯資料的級聯處理
  │
  ├─> 成功回應：
  │   └─> 返回 204 No Content
  │
  └─> 失敗回應：
      ├─> 403 Forbidden（無刪除權限）
      ├─> 404 Not Found（帳號不存在）
      └─> 409 Conflict（帳號有關聯資料無法刪除，如有實作）
```

**使用場景：**

1. 員工離職，刪除其系統帳號
2. 測試帳號使用完畢後清理
3. 違規帳號的停用與刪除

**實作重點：**

- 採用軟刪除機制，保留資料以供追蹤
- 刪除前應檢查關聯資料
- 考慮級聯刪除或保留關聯資料的策略
- 重要帳號刪除應有額外確認機制

---

## 4. 系統流程圖

### 4.1 帳號註冊流程

```
使用者註冊
  │
  ├─> 輸入帳號密碼
  │
  ├─> [驗證]
  │   ├─> 帳號格式檢查
  │   ├─> 密碼長度檢查（5-20位）
  │   └─> 帳號唯一性檢查
  │
  ├─> [成功] 建立帳號
  │   ├─> 密碼加密
  │   ├─> 儲存帳號資料
  │   │   - type: "Local"
  │   │   - account: 帳號名稱
  │   │   - password: 加密後密碼
  │   │   - createdAt: 建立時間
  │   └─> 返回帳號資訊
  │
  └─> [失敗] 返回錯誤訊息
      ├─> 參數驗證錯誤（400）
      └─> 帳號已存在（409）
```

### 4.2 帳號登入流程

```
使用者登入
  │
  ├─> 輸入帳號密碼
  │
  ├─> [驗證]
  │   ├─> 查詢帳號
  │   ├─> 檢查帳號存在
  │   └─> 密碼比對
  │
  ├─> [成功] 登入成功
  │   ├─> 更新最後登入時間
  │   ├─> 核發 JWT Token
  │   └─> 返回帳號資訊
  │
  └─> [失敗] 返回錯誤訊息
      └─> 401 Unauthorized
```

### 4.3 密碼修改流程

```
修改密碼
  │
  ├─> 輸入舊密碼與新密碼
  │
  ├─> [驗證]
  │   ├─> 驗證舊密碼
  │   ├─> 檢查新密碼格式
  │   └─> 檢查新舊密碼不同
  │
  ├─> [成功] 更新密碼
  │   ├─> 加密新密碼
  │   ├─> 更新資料庫
  │   └─> 返回成功訊息
  │
  └─> [失敗] 返回錯誤訊息
      ├─> 舊密碼錯誤（401）
      └─> 新舊密碼相同（400）
```

---

## 5. 時序圖

### 5.1 註冊時序圖

```
[客戶端]          [Controller]          [Service]          [Database]
   │                  │                     │                  │
   ├─ 註冊請求 ──────>│                     │                  │
   │                  ├─ create() ─────────>│                  │
   │                  │                     ├─ 檢查帳號 ──────>│
   │                  │                     │<─ 查詢結果 ──────┤
   │                  │                     │ (加密密碼)        │
   │                  │                     ├─ 建立帳號 ──────>│
   │                  │                     │<─ 建立成功 ──────┤
   │                  │<─ 帳號資料 ─────────┤                  │
   │<─ 註冊成功 ──────┤                     │                  │
   │                  │                     │                  │
```

### 5.2 登入時序圖

```
[客戶端]          [Controller]          [Service]          [Database]
   │                  │                     │                  │
   ├─ 登入請求 ──────>│                     │                  │
   │                  ├─ login() ──────────>│                  │
   │                  │                     ├─ 查詢帳號 ──────>│
   │                  │                     │<─ 帳號資料 ──────┤
   │                  │                     │ (驗證密碼)        │
   │                  │                     ├─ 更新登入時間 ──>│
   │                  │                     │<─ 更新成功 ──────┤
   │                  │<─ 帳號資料 ─────────┤                  │
   │<─ 登入成功 ──────┤                     │                  │
   │   + JWT Token     │                     │                  │
```

---

## 6. 事件流程說明

### 6.1 註冊事件流程

1. **客戶端發送註冊請求** → POST /api/user-account/register
2. **Controller 接收請求** → 驗證 DTO 格式
3. **Service 處理業務邏輯**：
   - 檢查帳號是否已存在（可選）
   - 使用 bcrypt 加密密碼
   - 建立 UserAccount 記錄
4. **Database 儲存資料** → 返回建立的帳號資料
5. **返回成功回應** → 200 OK + 帳號資訊（不含密碼）

### 6.2 登入事件流程

1. **客戶端發送登入請求** → POST /api/user-account/login
2. **Controller 接收請求** → 驗證 DTO 格式
3. **Service 處理業務邏輯**：
   - 依據 account 查詢帳號
   - 使用 bcrypt.compare() 驗證密碼
   - 更新 lastLoginAt 欄位
   - 核發 JWT Token（如有整合認證模組）
4. **Database 更新登入時間** → 返回帳號資料
5. **返回成功回應** → 200 OK + 帳號資訊 + JWT Token

### 6.3 修改密碼事件流程

1. **客戶端發送修改請求** → PATCH /api/user-account/:id/password
2. **Controller 接收請求** → 驗證 DTO 格式
3. **Service 處理業務邏輯**：
   - 查詢帳號資料
   - 驗證舊密碼
   - 檢查新舊密碼不同
   - 加密新密碼
   - 更新密碼欄位
4. **Database 更新密碼** → 返回更新結果
5. **返回成功回應** → 200 OK + 帳號資訊

---

## 7. 業務規則與限制

### 7.1 帳號規則

- **帳號唯一性**：每個帳號名稱在系統中必須唯一（建議實作）
- **帳號格式**：帳號為必填欄位，不可為空字串
- **帳號類型**：支援 Local、Google、Line、Apple 四種類型
- **第三方帳號**：第三方帳號（Google/Line/Apple）的 account 欄位儲存第三方平台的使用者 ID

### 7.2 密碼規則

- **密碼長度**：密碼必須為 5-20 個字元
- **密碼加密**：所有密碼必須使用 bcrypt 加密後儲存
- **密碼比對**：使用 bcrypt.compare() 進行密碼驗證
- **修改密碼**：新密碼不可與舊密碼相同
- **第三方帳號**：第三方帳號的 password 欄位預設為空字串

### 7.3 權限規則

- **註冊權限**：根據系統設定，可能需要特定權限才能註冊（或開放公開註冊）
- **修改密碼**：使用者只能修改自己的密碼，除非擁有管理員權限
- **重設密碼**：需要管理員權限或通過驗證碼驗證
- **刪除帳號**：需要管理員權限

### 7.4 資料保護

- **密碼欄位**：API 回應中永遠不包含 password 欄位
- **軟刪除**：帳號刪除採用軟刪除機制（如有實作 deletedAt）
- **關聯保護**：刪除帳號時需考慮關聯資料的處理（User、Role、Verification 等）

---

## 8. 資料流向

### 8.1 註冊資料流

```
客戶端
  │
  ├─> 提供帳號密碼
  │
  ▼
Controller
  │
  ├─> 驗證 DTO 格式
  │
  ▼
Service
  │
  ├─> 檢查帳號唯一性（可選）
  ├─> 加密密碼
  │
  ▼
Database
  │
  ├─> 儲存帳號資料
  │   - id（自動生成）
  │   - type: "Local"
  │   - account
  │   - password（加密）
  │   - createdAt
  │   - updatedAt
  │
  ▼
返回帳號資訊（不含密碼）
```

### 8.2 登入資料流

```
客戶端
  │
  ├─> 提供帳號密碼
  │
  ▼
Controller
  │
  ├─> 驗證 DTO 格式
  │
  ▼
Service
  │
  ├─> 查詢帳號資料
  ├─> 比對密碼
  ├─> 更新 lastLoginAt
  │
  ▼
Database
  │
  ├─> 更新最後登入時間
  │
  ▼
返回帳號資訊 + JWT Token
```

### 8.3 關聯資料

```
UserAccount（帳號）
  │
  ├─> Verification（驗證碼記錄）
  ├─> SendSmsLog（簡訊發送記錄）
  ├─> SendMailLog（郵件發送記錄）
  ├─> UserAccountHasRole（帳號-角色關聯）
  ├─> UserAccountHasPermission（帳號-權限關聯）
  ├─> User（使用者資料）
  └─> VerifyToken（驗證令牌）
```

---

## 9. 非功能性需求

### 9.1 安全性需求

- **密碼加密**：所有密碼必須使用 bcrypt 加密，不可明文儲存
- **密碼強度**：建議前端實作密碼強度檢查，提升安全性
- **登入保護**：建議實作登入失敗次數限制，防止暴力破解
- **Session 管理**：JWT Token 應設定適當的過期時間
- **HTTPS**：生產環境必須使用 HTTPS 加密傳輸

### 9.2 效能需求

- **查詢效能**：帳號查詢應在 100ms 內完成（單筆查詢）
- **登入效能**：登入流程應在 500ms 內完成（含密碼比對與 Token 核發）
- **並發處理**：系統應能同時處理至少 100 個登入請求
- **資料庫索引**：account 欄位應建立索引以加速查詢

### 9.3 可用性需求

- **錯誤訊息**：提供清楚的錯誤訊息，但不洩漏安全資訊
- **回應時間**：所有 API 應在 1 秒內回應
- **API 文件**：提供完整的 Swagger API 文件

### 9.4 可維護性需求

- **程式碼品質**：遵循 NestJS 最佳實踐
- **測試覆蓋率**：核心功能應有單元測試與整合測試
- **日誌記錄**：記錄重要操作（註冊、登入、密碼修改等）
- **錯誤處理**：統一的錯誤處理機制

### 9.5 擴展性需求

- **多租戶支援**：帳號系統應支援多租戶架構（透過 User 關聯）
- **第三方登入擴展**：架構應易於新增其他第三方登入方式
- **權限系統整合**：與 Role、Permission 模組良好整合

---

## 10. 版本歷史

**文件版本歷史：**

| 版本 | 日期       | 說明                             | 作者        |
| ---- | ---------- | -------------------------------- | ----------- |
| v1.0 | 2025-01-17 | 初版發布，建立帳號管理系統分析文件 | Claude Code |

---

**© 2025 公有資產管理系統 API Documentation Team. All rights reserved.**
